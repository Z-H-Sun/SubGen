# SubOCR
This program utilizes [`BaiduOCR` API](https://cloud.baidu.com/doc/OCR/s/Ek3h7xypm) to convert image files of subtitles generated by [`VideoSubFinder`](https://sourceforge.net/projects/videosubfinder/) into plain texts. It is a submodule for [`SubGen`](/README.md).

It is licensed under the [GNU General Public License v3.0](/LICENSE), and it is based in part on the work of the Independent JPEG Group and NAKAMURA Usaku.

Copyright © 1991-2018, Thomas G. Lane, Guido Vollbeding. All rights reserved.

Copyright © 2007,2011 NAKAMURA Usaku usa@garbagecollect.jp. All rights reserved.

## Preparation
### System requirements
This program is Ruby-based and therefore cross-platform, and the tests on Windows XP (x86) and 10 (x64), Mac OS X, and Ubuntu 18.04 has passed. However, it mainly targets Windows users.
* MacOS users: Ruby 2.0 environment is built-in on Mac OS X. However, you still need to compile the library dependency [`jpeg`](https://github.com/unak/jpeg) by yourself as instructed in [this chapter](https://github.com/Z-H-Sun/jpeg#how-to-build-on-mac-os-or-linux)
* Linux users: You have to deploy Ruby environment by, say, `apt-get install ruby-full`. In addition, you need to compile the library dependency [`jpeg`](https://github.com/unak/jpeg) by yourself as instructed in [this chapter](https://github.com/Z-H-Sun/jpeg#how-to-build-on-mac-os-or-linux)
* **Windows users**: NO special requirements AT ALL. The ONLY thing you should do is to download the latest release and run `SubOCR.exe`. You can view it as a minimal Ruby 1.8.7 environment (with the library dependency [`jpeg`](https://github.com/unak/jpeg) **included**), so you do NOT need to install Ruby on your PC. (*However, ONLY if you would VERY MUCH like to use your OWN Ruby environment, you will have to compile the library dependency [`jpeg`](https://github.com/unak/jpeg) by yourself as instructed in [this chapter](https://github.com/Z-H-Sun/jpeg#how-to-build-on-windows)*)
* **For any OS**, you MUST have access to the Internet becauese the program will send requests to BaiduOCR web-based API.

### BaiduOCR API application
* Follow [this link](https://console.bce.baidu.com/ai/?fromai=1#/ai/ocr/overview/index), sign in via your Baidu account, fill up the form, and hit "Apply"
* In the "Overview" page, click "Create an application," fill in any blank that is necessary, and click "Create Now"
* Now you will be taken to the app management page, where you can see your **`API Key` and `Secret Key`** as 24- and 32-digit alphanumeric strings, respectively
* **IMPORTANT!!!** Take them down, and replace with them the corresponding placeholders at the beginning of `SubOCR.rb` (Fig. 1)
* Note: For each account, there is a 500 OCR request limit for ACCURATE mode (and 50,000 for GENERAL mode). **It is recommended to apply for multiple API Keys using various Baidu accounts.** You can append as many of them as you like to the `API_KEY` constant in `SubOCR.rb`

<p align="center">
<img width="80%" height="80%" src="/SubOCR/pic/1.png">
</br>Fig. 1 How to fill API Keys and Secret Keys in SubOCR.rb
</p>

## Usage
### How to run the program
* Before running the program, you need to configure the program properly as instructed in [the following section](#configurations)
* MacOS and Linux users: You will only need to download this file, [`SubOCR.rb`](/SubOCR/SubOCR.rb). Then, run `ruby </path/to/>SubOCR.rb` in Terminal
* **Windows users**: You can download the latest release, extract it to an arbitrary path, and double click on `SubOCR.exe` to run; it will then execute the Ruby scripts written in `SubOCR.rb` (ONLY if you would VERY MUCH like to use your OWN Ruby environment, you can also try `ruby </path/to/>SubOCR.rb` in CMD)
* It is recommended to start the program in **the same directory** as `VideoSubFinder`, so that the program will know where to load the images (the `RGBImages` folder) and there to save the OCR Results (the `TXTResults` folder)

### Configurations
* You need to open `SubOCR.rb` with a plain text editor, say, Notepad for Win, TextEdit for Mac, Gedit for Linux Desktop
* If you are familiar with the Ruby language and would like to customize the functionality according to your own special needs, you can make changes to any part of the file. HOWEVER, for ordinary users, **you can just focus on the beginning part** (Fig. 1). The comments for all settings are quite clear and straightforward. Follow these guidelines when you feel it necessary to alter them

  * The most important part, `API_KEY`, has been introduced in [the last section](#baiduocr-api-application), which **you MUST alter**
  * There are two modes of OCR, ACCURATE and GENERAL. The former, as its name implies, is very very accurate, whereas the latter is not so good and often requires manual correction. As a result, we want to make as many ACCURATE OCR requests as possible. However, if we use up the daily quota of one API Key for the ACCURATE mode, **we will first try the next API Key; if all of them are used up, we will have to try the GENERAL mode**. The above explains how `DEFAULT_MODE` works. Generally, you do NOT want to alter its value
  * Considering the daily request limitation of the ACCURATE mode, this program has a built-in function to piece together several (*n* = 2 to 6) images into a bigger one, so that **the number of requests can be reduced by *n* times**

    * Define *n* in the constant `TOTAL_MOIETIES` (Default = 4)
    * The program will crop the images by taking 1/*n* of its original height. Thus, you should tell the program which 1/*n* part of the image contains the subtitle by defining `MOIETY_REGION`, which is a fraction between 0 and 1. The starting position is at (`MOIETY_REGION`−1/*n*) of the original height, and the ending position is then of course `MOIETY_REGION` of the original height. For example, if `MOIETY_REGION` = 0, the cropped image is at the very top; if `MOIETY_REGION` = 1, it is the the very bottom. **Usually, the subtitle is at the bottom, but not the very bottom, of the image, so you can set it as a value close to 1** (Default = 0.95)
    * `BaiduOCR` can still differenciate the words from different images by dividing all the words into parapraphs according to the vertical spacings, which will be made use of by this program. **In this regard, you should make sure the spacings between the words from different images are relatively large (i.e. `TOTAL_MOIETIES` should not be too large)** so that `BaiduOCR`'s segmentation of paragraphs functions properly
  * Other parameters are self-explanatory

### How to operate
* First of all, click "Run Search" in `VideoSubFinder` and get the images. It will take about 10 to 30 minutes for a 2-hour-long movie with 800 to 1500 subtitles. **NO NEED to and DO NOT run "Create Cleared Text Images."** The RGBImages will suffice and there will be no risk of data loss; in addition, a lot of time will be saved
* Check the [configurations](#configurations) and run `SubOCR.rb` (preferably, in the same folder as `VideoSubFinder`)
* If you are running `SubOCR.exe`, you will have the chance whether to show the OCR results in the terminal window or save to a logfile (Fig. 2). If you choose the latter, you can focus better on the warning/error messages. **Either way, the results will be saved to .txt files in the `TXTResults` folder**
* If you are not in the QUIET mode, you will see a few prompts. Just follow them, which are quite self-explanatory (Fig. 2)
* As described before, `BaiduOCR` can differenciate the words from different images by dividing all the words into parapraphs according to the vertical spacings. However, there is a small probability that the paragraphs are segmented wrongly (Fig. 2)
  * This can happen when the line spacing is close to the vertical spacings between the words from different images, making it hard to tell whether they are from different "lines" or from different "paragraphs", leading to more output paragraphs than expected;
  * Or when there is an image where there is no recognizable text at all, making output paragraphs less than expected
  * Either way, the output results will start with a flag `!@!`, indicating segmentation error. **This requires manual correction in [`SubGen`](/README.md)**
  * To mitigate the issue, **you can set a smaller `TOTAL_MOIETIES`.** Or under some extreme conditions, you can set it to 1, which, however, is deprecated given the limited daily quota of the ACCURATE mode
<p align="center">
<img width="80%" height="80%" src="/SubOCR/pic/2.png">
</br>Fig. 2 Running results
</p>

* The OCR of each (spliced) image takes ~2 seconds, which means for a movie with 1200 subtitles and `TOTAL_MOIETIES = 4`, **it will only take 10 minutes**
* Then you can view the results either in the terminal window or in the logfile or in the `TXTResults` folder. Note that the encoding is UTF-8!

  * **You can then **use [`SubGen`](/README.md)** to do the manual correction and generate a .ass subtitle file**
  * Or, you can use the "Create Subtitle" function in `VideoSubFinder`. But unfortunately, `VideoSubFinder` does NOT support UTF-8 encoding, and there is a large chance it will say "unrecognized text," which means you have to re-encode the text files as ANSI (say, GBK for Chinese characters). **So, the best suggestion: use [`SubGen`](/README.md) instead!**
* It is very very rare that you will encounter a fatal error that leads to a corruption of the program. It is most likely that you made some bad changes to `SubOCR.rb`. If you are running `SubOCR.exe`, it will pop up the error message before exiting (Fig. 3), which can help you debug. However, if you are sure it is a bug of the program itself, please do not hesitate to [open an issue](https://github.com/Z-H-Sun/SubGen/issues/new)
<p align="center">
<img width="80%" height="80%" src="/SubOCR/pic/3.png">
</br>Fig. 3 Bug reports
</p>

## For Windows developers: how to compile the executable
\* This chapter is for Windows developers only. If you merely want to use the program, **there is no need to read this**
* The executable for Win32 can be generated by [`ExeRb`](https://osdn.net/projects/exerb/). Note that the newest version that supports ExeRB was **Ruby 1.8.7**
* The executable serves as a "wrapper script" that runs `SubOCR.rb`, so that you can still modify/add the functionalities by making changes to `SubOCR.rb`, and this "minimal Ruby environment" enables running the script on PCs where Ruby is not installed
* The wrapper script, [`SubOCR.wrapper.rb`](/SubOCR/wrapper/SubOCR.wrapper.rb), does the following:

  * Changing the code page to 65001 (UTF-8), which is essential since Ruby 1.8.7 does not support converting encodings
  * Enabling `STDOUT` redirecting
  * Running `SubOCR.rb` and showing fatal exceptions before exiting
* You can make changes to the wrapper script and then run `exerb SubOCR.exy` in the `wrapper` folder to generate the corresponding .exe file

  * The .exy file lists the dependencies of `SubOCR.rb`. You can modify the file as instructed by the `README` file of `ExeRb`
  * The dependencies are stored in the `wrapper/lib` folder, with `libjpeg-8.dll` and `jpeg.so` **included**. However, if you want to use a different version of `libjpeg` or Ruby, you can replace the files accordingly, or you can change the paths written in `SubOCR.exy`
